# H∆∞·ªõng d·∫´n c·∫•u h√¨nh Firebase Authentication & Firestore

## B∆∞·ªõc 1: T·∫°o Firebase Project

1. Truy c·∫≠p [Firebase Console](https://console.firebase.google.com/)
2. Click **Create a project** ho·∫∑c **Add project**
3. ƒê·∫∑t t√™n project v√† l√†m theo c√°c b∆∞·ªõc

## B∆∞·ªõc 2: Th√™m ·ª©ng d·ª•ng Web

1. Trong Firebase Console, click **Add app** (bi·ªÉu t∆∞·ª£ng web)
2. ƒê·∫∑t t√™n cho ·ª©ng d·ª•ng
3. Copy c·∫•u h√¨nh Firebase (s·∫Ω hi·ªÉn th·ªã sau khi t·∫°o)

## B∆∞·ªõc 3: K√≠ch ho·∫°t Google Authentication

1. Trong Firebase Console, v√†o **Authentication**
2. Click **Get started**
3. Ch·ªçn tab **Sign-in method**
4. Click **Google** v√† k√≠ch ho·∫°t
5. ƒêi·ªÅn **Project support email**
6. Click **Save**

## B∆∞·ªõc 4: K√≠ch ho·∫°t Firestore Database

1. Trong Firebase Console, v√†o **Firestore Database**
2. Click **Create database**
3. Ch·ªçn **Start in test mode** (cho development)
4. Ch·ªçn location g·∫ßn nh·∫•t (v√≠ d·ª•: asia-southeast1)
5. Click **Done**

## B∆∞·ªõc 5: C·∫•u h√¨nh Firestore Rules

1. Trong Firestore Database, v√†o tab **Rules**
2. C·∫≠p nh·∫≠t rules nh∆∞ sau:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Vocabulary progress - users can read/write their own progress
      match /vocabulary_progress/{document} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User notifications - users can read/write their own
      match /userNotifications/{userNotificationId} {
        allow read, write: if request.auth != null && 
          userNotificationId.matches(request.auth.uid + '_.*');
      }
    }
    
    // Exam Results - users can only access their own exam results
    match /examResults/{examResultId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.userId is string &&
        request.resource.data.userEmail is string &&
        request.resource.data.userName is string &&
        request.resource.data.examTitle is string &&
        request.resource.data.score is number &&
        request.resource.data.totalQuestions is number &&
        request.resource.data.percentage is number;
    }
    
    // Notifications - all authenticated users can read, server can write
    match /notifications/{notificationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null || request.auth == null; // Cho ph√©p server-side writes
    }
    
    // User notifications collection - users can read/write their own
    match /userNotifications/{userNotificationId} {
      allow read, write: if request.auth != null && 
        userNotificationId.matches(request.auth.uid + '_.*');
    }
    
    // Public data (optional)
    match /public/{document=**} {
      allow read: if true;
    }
    
    // Allow all reads for development (remove in production)
    match /{document=**} {
      allow read: if true;
    }
  }
}
```

**L∆∞u √Ω quan tr·ªçng:**

1. **Development Mode**: Rules hi·ªán t·∫°i cho ph√©p t·∫•t c·∫£ reads ƒë·ªÉ d·ªÖ development
2. **Production**: Tr∆∞·ªõc khi deploy production, h√£y thay ƒë·ªïi rules th√†nh:
   ```javascript
   // Production rules - ch·ªâ cho ph√©p authenticated users
   match /{document=**} {
     allow read, write: if request.auth != null;
   }
   ```

3. **Vocabulary Progress**: Users c√≥ th·ªÉ l∆∞u ti·∫øn ƒë·ªô h·ªçc t·∫≠p c·ªßa m√¨nh
4. **Notifications**: H·ªá th·ªëng notification ho·∫°t ƒë·ªông cho t·∫•t c·∫£ users
5. **Server-side**: Cho ph√©p GitHub Actions t·∫°o notifications t·ª± ƒë·ªông

## B∆∞·ªõc 6: L·∫•y c·∫•u h√¨nh Firebase

1. Trong Firebase Console, v√†o **Project settings** (bi·ªÉu t∆∞·ª£ng b√°nh rƒÉng)
2. Scroll xu·ªëng ph·∫ßn **Your apps**
3. Click v√†o app web ƒë√£ t·∫°o
4. Copy c·∫•u h√¨nh:

```javascript
const firebaseConfig = {
  apiKey: "your-api-key",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456"
}
```

## B∆∞·ªõc 7: C·∫•u h√¨nh Environment Variables

1. T·∫°o file `.env` t·ª´ `env.example`:
```bash
cp env.example .env
```

2. Th√™m th√¥ng tin Firebase v√†o file `.env`:
```
VITE_FIREBASE_API_KEY=your-api-key
VITE_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your-project-id
VITE_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=123456789
VITE_FIREBASE_APP_ID=1:123456789:web:abcdef123456
```

## B∆∞·ªõc 8: C·∫•u h√¨nh nhanh cho Development

### N·∫øu b·∫°n mu·ªën test ngay m√† kh√¥ng c·∫ßn c·∫•u h√¨nh Firebase:

1. **T·∫°m th·ªùi disable Firebase**: ·ª®ng d·ª•ng s·∫Ω ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng v·ªõi demo data
2. **Kh√¥ng c·∫ßn file .env**: Firebase s·∫Ω s·ª≠ d·ª•ng demo config
3. **Ch·ª©c nƒÉng b·ªã h·∫°n ch·∫ø**: 
   - Kh√¥ng l∆∞u ti·∫øn ƒë·ªô h·ªçc t·∫≠p
   - Kh√¥ng c√≥ notifications
   - Kh√¥ng c√≥ user authentication

### ƒê·ªÉ b·∫≠t ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng:

1. T·∫°o Firebase project theo h∆∞·ªõng d·∫´n tr√™n
2. Copy c·∫•u h√¨nh v√†o file `.env`
3. Deploy Firestore rules
4. Restart development server

## B∆∞·ªõc 9: Ki·ªÉm tra c·∫•u h√¨nh

1. M·ªü browser console
2. Ki·ªÉm tra c√°c th√¥ng b√°o:
   - ‚úÖ "Firebase configured successfully" = C·∫•u h√¨nh ƒë√∫ng
   - ‚ö†Ô∏è "Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh" = C·∫ßn c·∫•u h√¨nh th√™m
   - üîß "Connected to Firestore emulator" = ƒêang d√πng emulator

## T√≠nh nƒÉng Firebase Authentication & Firestore

### ‚úÖ ƒê√£ t√≠ch h·ª£p:
- **Google Sign-in**: ƒêƒÉng nh·∫≠p b·∫±ng Google
- **Auto-login**: T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p khi refresh trang
- **Real-time auth state**: C·∫≠p nh·∫≠t tr·∫°ng th√°i real-time
- **User Profile**: L∆∞u v√† qu·∫£n l√Ω th√¥ng tin c√° nh√¢n
- **Learning Stats**: Theo d√µi ti·∫øn ƒë·ªô h·ªçc t·∫≠p
- **Profile Editor**: Ch·ªânh s·ª≠a th√¥ng tin c√° nh√¢n
- **Notifications**: H·ªá th·ªëng th√¥ng b√°o real-time
- **Exam Results**: L∆∞u k·∫øt qu·∫£ thi l√™n Firestore
- **Exam History**: L·ªãch s·ª≠ l√†m b√†i thi c·ªßa user
- **Performance Tracking**: Theo d√µi ƒëi·ªÉm s·ªë v√† th√†nh t√≠ch
- **Secure logout**: ƒêƒÉng xu·∫•t an to√†n
- **Loading states**: Hi·ªÉn th·ªã tr·∫°ng th√°i loading
- **Error handling**: X·ª≠ l√Ω l·ªói ƒëƒÉng nh·∫≠p v√† l∆∞u d·ªØ li·ªáu

### üìä **C·∫•u tr√∫c d·ªØ li·ªáu Firestore:**

#### Collection: `users`
```javascript
{
  uid: "user-id",
  displayName: "T√™n hi·ªÉn th·ªã",
  email: "email@example.com",
  photoURL: "https://...",
  createdAt: timestamp,
  lastLoginAt: timestamp,
  updatedAt: timestamp,
  
  // Th√¥ng tin c√° nh√¢n
  personalInfo: {
    fullName: "H·ªç v√† t√™n",
    nickname: "Bi·ªát danh",
    dateOfBirth: "1990-01-01",
    phoneNumber: "0123456789",
    address: "ƒê·ªãa ch·ªâ",
    bio: "Gi·ªõi thi·ªáu",
    learningGoals: "M·ª•c ti√™u h·ªçc t·∫≠p",
    preferredLanguage: "vi",
    timezone: "Asia/Ho_Chi_Minh"
  },
  
  // Th·ªëng k√™ h·ªçc t·∫≠p
  learningStats: {
    totalStudyTime: 0,
    totalSessions: 0,
    currentStreak: 0,
    longestStreak: 0,
    lastStudyDate: null,
    favoriteTopics: [],
    completedLessons: 0
  },
  
  // C√†i ƒë·∫∑t ·ª©ng d·ª•ng
  settings: {
    notifications: true,
    soundEnabled: true,
    autoPlay: false,
    theme: "light",
    language: "vi"
  }
}
```

#### Collection: `notifications`
```javascript
{
  id: "notification-id",
  title: "Ti√™u ƒë·ªÅ th√¥ng b√°o",
  message: "N·ªôi dung th√¥ng b√°o",
  type: "info", // info, success, warning, error
  priority: "normal", // low, normal, high
  createdAt: timestamp,
  isActive: true,
  targetUsers: "all", // all, specific
  expiresAt: null
}
```

#### Collection: `userNotifications`
```javascript
{
  id: "userId_notificationId",
  userId: "user-id",
  notificationId: "notification-id",
  isRead: false,
  readAt: null,
  createdAt: timestamp
}
```

#### Collection: `examResults`
```javascript
{
  id: "auto-generated-id",
  userId: "user-id",
  userEmail: "user@example.com",
  userName: "T√™n ng∆∞·ªùi d√πng",
  examId: "exam_1234567890",
  examTitle: "B√†i thi ng·ªØ ph√°p N5",
  examType: "grammar", // grammar, vocabulary, kanji, hiragana, katakana, listening
  score: 42,
  totalQuestions: 50,
  percentage: 84.0,
  grade: "A", // A, B, C, D
  timeSpent: 1800, // in seconds (30 minutes)
  answers: {
    0: "A",
    1: "B", 
    2: "C",
    // ... user answers for each question
  },
  flaggedQuestions: [5, 12, 23], // array of flagged question indices
  completedAt: timestamp,
  createdAt: timestamp
}
```

### üîß C√≥ th·ªÉ m·ªü r·ªông:
- **Email/Password**: ƒêƒÉng nh·∫≠p b·∫±ng email
- **Phone**: ƒêƒÉng nh·∫≠p b·∫±ng s·ªë ƒëi·ªán tho·∫°i
- **Anonymous**: ƒêƒÉng nh·∫≠p ·∫©n danh
- **Social providers**: Facebook, Twitter, GitHub
- **Role-based access**: Ph√¢n quy·ªÅn ng∆∞·ªùi d√πng
- **Learning Progress**: L∆∞u ti·∫øn ƒë·ªô h·ªçc t·∫≠p
- **Achievements**: H·ªá th·ªëng th√†nh t√≠ch
- **Study Sessions**: L∆∞u l·ªãch s·ª≠ h·ªçc t·∫≠p
- **Exam Analytics**: Ph√¢n t√≠ch chi ti·∫øt k·∫øt qu·∫£ thi
- **Progress Charts**: Bi·ªÉu ƒë·ªì ti·∫øn b·ªô theo th·ªùi gian
- **Exam Recommendations**: G·ª£i √Ω b√†i thi ph√π h·ª£p
- **Leaderboards**: B·∫£ng x·∫øp h·∫°ng th√†nh t√≠ch
- **Study Streaks**: Theo d√µi chu·ªói ng√†y h·ªçc li√™n ti·∫øp
- **Wrong Answer Review**: √în t·∫≠p c√¢u tr·∫£ l·ªùi sai
- **Exam Sharing**: Chia s·∫ª k·∫øt qu·∫£ v·ªõi b·∫°n b√®
- **Push Notifications**: Th√¥ng b√°o push
- **Notification Preferences**: T√πy ch·ªânh th√¥ng b√°o

## L∆∞u √Ω quan tr·ªçng

- **Security**: Firebase t·ª± ƒë·ªông x·ª≠ l√Ω b·∫£o m·∫≠t
- **Real-time**: D·ªØ li·ªáu c·∫≠p nh·∫≠t real-time
- **Offline Support**: Firestore h·ªó tr·ª£ offline
- **Production**: T·ª± ƒë·ªông ho·∫°t ƒë·ªông tr√™n production
- **Analytics**: Firebase cung c·∫•p analytics mi·ªÖn ph√≠
- **Backup**: D·ªØ li·ªáu ƒë∆∞·ª£c backup t·ª± ƒë·ªông
- **Notifications**: T·ª± ƒë·ªông t·∫°o th√¥ng b√°o khi deploy

## Troubleshooting

### L·ªói "auth/unauthorized-domain"
- Th√™m domain v√†o Firebase Console > Authentication > Settings > Authorized domains

### L·ªói "auth/popup-closed-by-user"
- Ki·ªÉm tra popup blocker
- ƒê·∫£m b·∫£o domain ƒë∆∞·ª£c authorize

### L·ªói "permission-denied" trong Firestore
- Ki·ªÉm tra Firestore Rules
- ƒê·∫£m b·∫£o user ƒë√£ ƒëƒÉng nh·∫≠p

### L·ªói "network-request-failed"
- Ki·ªÉm tra k·∫øt n·ªëi internet
- ƒê·∫£m b·∫£o Firebase project ƒë√£ ƒë∆∞·ª£c t·∫°o ƒë√∫ng

### L·ªói "notifications not showing"
- Ki·ªÉm tra Firestore Rules cho notifications
- ƒê·∫£m b·∫£o user ƒë√£ ƒëƒÉng nh·∫≠p
- Ki·ªÉm tra console logs

### L·ªói "exam results not saving"
- ƒê·∫£m b·∫£o user ƒë√£ ƒëƒÉng nh·∫≠p
- Ki·ªÉm tra Firestore Rules cho examResults
- Ki·ªÉm tra network connectivity
- ƒê·∫£m b·∫£o d·ªØ li·ªáu exam h·ª£p l·ªá

## T√≠nh nƒÉng L∆∞u K·∫øt Qu·∫£ Thi

### üìä **C√°ch ho·∫°t ƒë·ªông:**

1. **Ho√†n th√†nh b√†i thi**: User l√†m xong b√†i thi
2. **Hi·ªÉn th·ªã k·∫øt qu·∫£**: Xem ƒëi·ªÉm s·ªë v√† grade
3. **ƒêƒÉng nh·∫≠p (n·∫øu ch∆∞a)**: C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u
4. **B·∫•m "L∆∞u k·∫øt qu·∫£"**: L∆∞u l√™n Firestore
5. **X√°c nh·∫≠n**: Th√¥ng b√°o l∆∞u th√†nh c√¥ng

### üîê **B·∫£o m·∫≠t:**

- User ch·ªâ c√≥ th·ªÉ l∆∞u k·∫øt qu·∫£ c·ªßa ch√≠nh m√¨nh
- D·ªØ li·ªáu ƒë∆∞·ª£c validate tr∆∞·ªõc khi l∆∞u
- Ch·ªëng tr√πng l·∫∑p k·∫øt qu·∫£
- Timestamp t·ª± ƒë·ªông t·ª´ server

### üìà **D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u:**

- **Th√¥ng tin user**: ID, email, t√™n
- **Chi ti·∫øt b√†i thi**: Ti√™u ƒë·ªÅ, lo·∫°i thi, ID
- **K·∫øt qu·∫£**: ƒêi·ªÉm s·ªë, t·ªïng c√¢u, ph·∫ßn trƒÉm, grade
- **Th·ªùi gian**: Th·ªùi l∆∞·ª£ng l√†m b√†i
- **Chi ti·∫øt**: ƒê√°p √°n c·ªßa user, c√¢u ƒë√£ flag
- **Metadata**: Th·ªùi gian ho√†n th√†nh, t·∫°o

### üéØ **S·ª≠ d·ª•ng sau n√†y:**

```javascript
// L·∫•y l·ªãch s·ª≠ thi c·ªßa user
const history = await getUserExamHistory(userId, 10)

// L·∫•y th·ªëng k√™ thi c·ªßa user  
const stats = await getUserExamStats(userId)
```

### ‚ö†Ô∏è **L∆∞u √Ω:**

- **Offline**: Kh√¥ng th·ªÉ l∆∞u khi offline
- **Guest mode**: Ph·∫£i ƒëƒÉng nh·∫≠p m·ªõi l∆∞u ƒë∆∞·ª£c
- **Production**: ƒê·∫£m b·∫£o Firestore Rules ƒë√£ c·∫≠p nh·∫≠t
- **Performance**: Ch·ªâ l∆∞u khi user click button 